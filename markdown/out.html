<style id="system" type="text/css">*{margin:0;padding:0;} html { font-size: 100%; overflow-y: scroll; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; background:#eeeeee;} body {	font:15px helvetica,arial,freesans,clean,sans-serif;	color:black;	line-height:1.4em;	background-color: #FFF;	padding: 0.7em;} p {	margin:1em 0;	line-height:1.5em;} table {	font-size:inherit;	font:100%;	margin:1em;} table th{border-bottom:1px solid #bbb;padding:.2em 1em;} table td{border-bottom:1px solid #ddd;padding:.2em 1em;} input[type=text],input[type=password],input[type=image],textarea{font:99% helvetica,arial,freesans,sans-serif;} select,option{padding:0 .25em;} optgroup{margin-top:.5em;} pre,code{font:13px "DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;} pre {	margin:1em 0;	font-size:13px;	background-color:#eee;	border:1px solid #ddd;	padding:5px;	line-height:1.5em;	color:#444;	overflow:auto;	-webkit-box-shadow:rgba(0,0,0,0.07) 0 1px 2px inset;	-webkit-border-radius:3px;	-moz-border-radius:3px;border-radius:3px;} pre code {	padding:0;	font-size:13px;	background-color:#eee;	border:none;} code {	font-size:13px;	background-color:#eee;	color:#d14; pading:2px 4px border:1px solid #elele8;border-radius:3px} img{border:0;max-width:100%;} abbr{border-bottom:none;} a{color:#4183c4;text-decoration:none;} a:hover{text-decoration:underline;} a code,a:link code,a:visited code{color:#4183c4;} h2,h3{margin:1em 0;} h1,h2,h3,h4,h5,h6{border:0;} h1{font-size:170%;border-bottom:3px solid #aaa;padding-top:.5em;padding-bottom:.5em;margin-top:1.5em;} h1:first-child{margin-top:0;padding-bottom:.25em;border-top:none;} h2{font-size:150%;margin-top:1.5em;border-bottom:3px solid #e0e0e0;padding-bottom:0.5em;} h3{margin-top:1em;} hr{border:1px solid #ddd;} ul{margin:1em 0 1em 2em;} ol{margin:1em 0 1em 2em;} ul li,ol li{margin-top:.5em;margin-bottom:.5em;} ul ul,ul ol,ol ol,ol ul{margin-top:0;margin-bottom:0;} blockquote{margin:1em 0;border-left:5px solid #ddd;padding-left:.6em;color:#555;} dt{font-weight:bold;margin-left:1em;} dd{margin-left:2em;margin-bottom:1em;} @media screen and (min-width: 768px) {    body {        width: 748px;        margin:10px auto;    } } </style><style id="custom" type="text/css"></style></head> <body marginheight="0"><html><h1>URL版本</h1>
<h2>url提取</h2>
<p>
</p><h3>不同形式url的统一、最简解义</h3>
<ul>
<li>host后面的`%20`应该简化
</li>
<li>
大小写统一
</li>

</ul>
<h3>发现一个tcp报文中可能会有多个http get的报文:</h3>
<ul>
<li>解析时候要全部解析
</li>
<li>
dpp结构里面要加上组织成链表添加url
</li>
<li>
匹配时候要多次进行查找
</li>
<pre><p>    struct url_str {
    	struct url_str	*next;
    	char 			*str;
    };
</pre></p></ul>
<p>
</p><h3>字符串隐晦规则</h3>
<p>字符串长度,数组和字符串常量最后一位都是0x00，printf(%s)通过这个进行判断,内存所以比实际长度长一位：
</p><pre><p>    char tmp[] = "abcd";	/* sizeof = 5,最后一位是0x00 */
    char tmp_1[4] = "abcd"; /* sizeof = 4,打印字符串最后有乱码 */
    char *p = "abcd";		/* sizeof = 8,地址占用的长度。不清楚字符串常量长度怎么确定，有人说和tmp[]相似 */
</pre></p><p>就是说字符串存储默认在最后一位留下<code>0x00</code>作为结束符，也方便使用库函数（printf、strlen）等函数处理。
</p><p>
</p><h3>绝对URL abs_url：</h3>
<pre><p>    http://www.---
</pre></p><p>
</p><h3>绝对路径 abs_path：</h3>
<pre><p>    /s?get=adad&dadad
</pre></p><p>url起始位置：不带着<code>http://</code>
</p><p>
</p><p>cvmx_malloc: 内存申请size可否是0.
</p><p>
</p><h3>void *ptr = str;无类型指针被赋值后，使用时可以进行强转后使用。</h3>
<pre><p>	struct {
			void *url;
	} dpp;
</pre></p><p>
</p><h2>模块位置</h2>
<p>模块按照分层的，结构还是分格---》最后称为网格结构。
</p><p>
</p><h2>日志系统</h2>
<p>阻断日志实时的进行发送，不依赖于流表
</p><p>访问日志是依赖流表原有的发送功能
</p><p>
</p><h3>访问日志开关和出口设置</h3>
<pre><p>juson(config-cpu0)# set sregister fmt_manage
ttlset               set fmt default aging time
stat_eif             set egress interface group that fmt stat packet will go with
send_stat            set enable of send fmt stat packet
</pre></p><p>
</p><h2>删除url_block send_log 开关</h2>
<p>作为访问日志的开关使用，没有删除
</p><p>
</p><h2>组织访问日志逻辑</h2>
<h3>流表结构添加新位域</h3>
<p><table>
</p><p>	<tr>
</p><p>		<td> zxmx_fmt_api.h </td>
</p><p>		<td> fmt_key_t </td>
</p><p>		<td> md_fmt_t </td>
</p><p>	</tr>
</p><p></table>
</p><p>
</p><pre><p>	#ifndef CONFIG_URL_BLOCK                                              
                    pkts:40;    /* Total packets in Flow, RO */       
	#else                                                                 
                    bidir_en:1,                                       
                    rst_en:1,   /* reset flag */                      
                    rst_num:4,  /* the pkts after sent reset packet */
                    [[pkts:34;]]    /* Total packets in Flow, RO */       
	#endif                                                                
</pre></p><h3>各个规则模块添加rst标志，定义一个通用的结构给各个规则模块</h3>
<p>
</p><h2>vlan更改</h2>
<p>66从掩码从6位变作5位
</p><p>
</p><h4>30s-3min 没有发送访问日志(只在30s 3min发送访问日志)</h4>
<p>
</p><blockquote>
30s-3min的那是建流表时候设置活动位，以后search的时候在把活动位置位，但是现在命中的报文被url模块给劫持了，活动位失效了，就不会这段时间就不会发送访问日志了（不过发没有命中的相同流报文可以激活活动位，再次发送访问日志)
</blockquote>
<p>
</p><p>保证30s-3min发送，在<code>fmt_add()</code>__find exist__的地方设置<code>dyn = 1</code>；
</p><p>强调性能，只在3min时候发送，在<code>fmt_timeout()</code> 30s检测地方，把判断<code>dyn == 1</code>然后发送的地方注释掉，在aged或ttl减到零时候发送
</p><p> 
</p><p>ttl在search_refresh处会被刷新fl->k.ttl = fl->k.ttl_set;
</p><p>
</p><h4>发送10个或者10的倍数个相同报文，会发送两个日志(和30-3问题同时存在时候，在3min时候也会发送两个)</h4>
<p>
</p><blockquote>
发送两个两个报文肯定是建立连个不同的流表，所以每个流表项才都会发送两个
</blockquote>
<p>
</p><blockquote>
观察发送出来的两个报文发现port结构位置的port位不对，一次是0，一次是1
</blockquote>
<p>
</p><p>- 09bf 0050 __0__411 2200
</p><p>- 09bf 0050 __1__411 2200
</p><p>
</p><p>定位到fmt_proto的枚举，往常在流表模块开启的时候dpp->fmt_proto在fmt_process中设置: <code>dpp->fmt_proto = FMT_PROTO_UDP;</code>
</p><p>
</p><p>上面两个问题都是由于url模块加在流表模块之间，考虑不周全导致的问题。
</p></html>