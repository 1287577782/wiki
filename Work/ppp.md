## 前言
### LCP
链路控制协议（LCP) LCP 建立点对点链路，是 PPP 中实际工作的部分。LCP 位于物理层的上方，负责建立、配置和测试数据链路连接。LCP 还负责协商和设置WAN 数据链路上的控制选项，这些选项由 NCP 处理。

### NCP
NCP 网络控制协议 PPP允许多个网络协议共用一个链路，网络控制协议 (NCP) 负责连接PPP（第二层）和网络协议 (第三层) 。对于所使用的每个网络层协议，PPP都分别使用独立的NCP来连接。例如，IP 使用 IP 控制协议 (IPCP)，IPX 使用 Novell IPX 控制协议 (IPXCP)。

### 认证协议
* PAP：口令验证协议(Password Authentication Protocol)
* CHAP：挑战握手验证协议(Challenge-Handshake Authentication Protocol)

## PPP通信步骤
### 阶段一：创建PPP链路
LCP负责创建链路。在这个阶段，将对基本的通讯方式进行选择。链路两端设备通过LCP向对方发送配置信息报文（Configure Packets）。 一旦一个配置成功信息报文（Configure-Ack Packet）被发送且被接收，就完成交换，进入LCP开启状态。在链路创建阶段，只是对验证协议进行选择，用户验证将在第2阶段实现。

###  阶段二：用户验证
在这个阶段，客户端会将自己的身份发送给远端的接入服务器。该阶段使用一种安全验证方式避免第三方窃取数据或冒充远程客户接管与客户端的连接。在认证完成之前，禁止从认证阶段前进到网络层协议阶段。如果认证失败，认证者应该跃迁到链路终止阶段。

在这一阶段里，只有链路控制协议、认证协议，和链路质量监视协议的 packets是被允许的。在该阶段里接收到的其他的packets必须被静静的丢弃。

最常用的认证协议有口令验证协议（PAP）和挑战握手验证协议（CHAP）。

### 阶段三：调用网络层协议
认证阶段完成之后，PPP将调用在链路创建阶段（阶段1）选定的各种网络控制协议（NCP）。选定的NCP解决PPP链路之上的高层协议问题，例如，在该阶段IP 控制协议（IPCP）可以向拨入用户分配动态地址。

这样，经过三个阶段以后，一条完整的PPP链路就建立起来了。


## 认证方式
### 口令验证协议（PAP）
$RFC1334$明文用户名/口令认证方式。
在PPP中的协议号是`0xc023`，后面仅跟格式：
PAP format:
```
	code		8
	identifier	8
	length	16	所有的长度
	data		0 ～ n
```
data format：
```
	len		strlen(str)
	str
```
Code：1字节，表示PAP包的类型
* 1 认证请求
* 2 认证确认
* 3 认证失败 
 
#### 认证请求 
`code = 1`
* Peer-ID-Length:长度1字节，表示Peer-ID域的长度
* Peer-ID：可为0到多个字节长，表示认证对方的名称
* Passwd-Length：长度1个字节，表示Password域的长度
* Password：可为0到多个字节长，表示认证的口令，明文

#### 认证确认，认证失败
`code = 2,code = 3`
* Msg-Length：长度1个字节，表示Message域的长度
* Message：可为0到多个字节长，具体内容由实际时显示确定
 
### 挑战-握手验证协议（CHAP）
$RFC 1994$ 挑战响应式协议。
协议号是`0xc223`，后面仅跟格式：
CHAP Format:
```
	code	8
	identifier 8
	length	16
```
Code:
* 1 挑战
* 2 响应
* 3 成功
* 4 失败

#### 挑战，响应
`code = 1`, `code = 2`
data格式：
```
	value-size	8,仅包含value的长度
	value		至少是一个字节，可变长
	name		至少一个字节，必须是以'\0'或'\r\n'结束,
				也可以根据length,value-size计算出来(length - 4 - 1 - value-size)
```

#### 成功，失败
`code = 3`,`code = 4`
data格式
```
Message可以是0字节，也可以是多个字节，内容可以根据实际应用自己确定。
```

### PPP协议帧结构
```
0>>	8		16		24		40 		Variable	16-32bits
	Flag	Address	Control	Protocol	Information	FCS
```
* Flag ：标志字段，表示帧的起始或结束。所有的PPP帧都是由一个标准的HDLC标志二进制字节（01111110）作为开始的。如果它正好出现在Information字段中，则需要进行字节填充。"《网络工程师必读——网络工程基础》一书。"

* Address：地址字段，它总是被设置成二进制值：1111 1111，以表示所有的站都可以接受该帧。它是一个标准的广播地址（注意：PPP通信不分配个人站地址）。

* Control ：控制字段，默认为二进制值：00000011，表示这是一个无序号帧。也就是说，在默认情况下，PPP协议并没有采用序列号和确认应答来实现可靠传输。在有噪声的环境下（如无线网络中），可以利用编号模式来实现可靠传输。

* Protocol：协议字段，识别帧中Information 字段封装的协议。已定义的协议代码包括：LCP、NCP、IP、IPX、AppleTalk等。以0 位作为开始的协议是网络层协议，如IP、IPX、XNS等；以1位作产开始的协议被用于协商其他的协议，如LCP、NCP。协议的默认大小为2字节，但是通过LCP可以将它协商为1个字节。

* Information：信息字段（又称“净荷域”），可以是任意长度，包含Protocol 字段中指定的协议数据报。如果在线路建立过程中没有通过LCP 协商该长度，则使用默认长度1500字节。如果有需要的话，在该字段之后可以加上一些填充字节。

* FCS：帧校验序列（FCS）字段，通常为16位（2个字节长），也可以为4个字节。PPP的执行可以通过预先协议采用32位FCS来提高差错检测效果。 PPP数据帧的格式看上去很像ISO 的HDLC（高级链路控制协议）标准。每一帧都以标志字符0x7e开始和结束。紧接着是一个地址字节，值始终是0xff，然后是一个值为0x03的控制字节。接下来是协议字段，类似于以太网中类型字段的功能。 CRC字段（或FCS，帧检验序列）是一个循环冗余检验码，以检测数据帧中的错误。 

### 转义
由于标志字符的值是0x7e，因此当该字符出现在信息字段中时，PPP 需要对它进行转义。在同步链路中，该过程是通过一种称作比特填充（bitstuffing）的硬件技术来完成的；在异步链路中，特殊字符0x7d用作转义字符。当它出现在PPP数据帧中时，那么紧接着的字符的第6个比特要取其补码，具体实现过程如下：
* 当遇到字符0x7e时，需连续传送两个字符：0x7d和0x5e，以实现标志字符的转义。

* 当遇到转义字符0x7d时，需连续传送两个字符：0x7d和0x5d，以实现转义字符的转义。

* 默认情况下，如果字符的值小于0x20（比如，一个ASCII控制字符），一般都要进行转义。例如，遇到字符0x01时需连续传送0x7d和0x21两个字符（这时，第6个比特取补码后变为1，而前面两种情况均把它变为0。


## 与HDLC
PPP帧格式与HDLC协议帧格式非常类似。他们之间的主要区别是，PPP面向字符的而HDLC是面向位（比特）的。另外，PPP 协议在调制解调器上使用了字节填充技术，所以，所有的帧都是整数个字节。

PPP与HDLC的区别  
1.从网络层交下来的分组，变成为数据链路层的数据。信息字段的长度没有具体规定。数据链路层在信息字段的头尾各加上24bit 的控制信息，这样就构成了一个完整的帧。HDLC规定了一个帧的开头（即首部中的第一个字节）和结尾（即尾部中的最后一个字节）各放入一个特殊的标记，作为一个帧的边界。这个标记就叫做标志字段F。标志字段F为６个连续１加上两边各一个０共８位。地址字段A也是８个比特，它一般被写入次站的地址。帧校验序列FSC字共占16 位，采用CRC-CCITT生成多项式。控制字段功８位，是最复杂的字段,HDLC的许多重要功能都要靠控制字段来实现。根据其前面两个比特的取值，可将HDLC的许多帧划分为三大类，即信息帧、监督帧和无编号帧。     
    
2.点对点协议PPP的帧结构：PPP帧格式和HDLC的相似，PPP帧的前3个字段和最后两个字段和HDLC的格式是一样的。PPP不是面向比特的，因而所有的PPP帧的长度都是整数个字节。与HDLC不同的是多了一个2个字节的协议字段。当协议字段为0X0021时，信息字段就是IIP数据报。若为0XC021,则信息字段是链路控制数据，而0X8021表示这是网络控制数据。HDLC使用时是cisco私有的协议，该协议仅适合cisco设备间互连用，不能用于其他设备.

## 其他
CCP:RFC1962——The PPP Compression Control Protocol  定义了一种在PPP链路上协商数据压缩算法的方法

PPP协议域：00FD，80FD，80FB --- CCP

为了在一条PPP链路上建立通信，链路的两端首先发送LCP包配置和检测数据链路。链路建立后，可选的功能中的一些值作为需要将被协商。链路的每个方向可能采有不同的压缩算法，或只有一个方向上的数据包被压缩。
```
	code		8
	identifier	8
	length		16
	data
```
这里data就是options：	与LCP的options类似。
```
	type		8
	len			8	整个options的长度
```
