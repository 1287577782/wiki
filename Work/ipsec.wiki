	IPsec(Internet Protocol Security),是通过对IP协议（互联网协议）的分组进
	行加密和认证来保护IP协议的网络传输协议族（一些相互关联的协议的集合）。

	IPsec 由两大部分组成：（1）建立安全分组流的密钥交换协议；（2）保护分组
	流的协议。
	前者为互联网金玥交换（IKE）协议；
	后者包括加密分组流的封装安全载荷协议（ESP）协议或认证头协议（AH）协议;

IPsec提供以下安全服务：
	1. 数据机密性（Confidentiality）：IPsec 发送方在通过网络传输包前对包进	1.加密
	   行加密。
	2. 数据完整性（Data Integrity）：IPsec接收方对发送方发送来的包进行认证	2 3. 认证
	   也确保数据在传输过程中没有被篡改。
	3. 数据来源认证（Data Authentication）：IPsec在接收端可以认证发送IPsec
	   的发送段是否合法。
	4. 防重放（Anti-Replay）：IPsec接收方可检测并拒绝过时或重复的报文。
优点：
	1. 支持IKE （Internet Key Exchange，因特网密钥交换），可实现密钥的自动
	   协商功能，减少密钥协商的开销。可以通过IKE建立和维护SA的服务，简化IP
	   sec的使用和管理。
	2. 所有使用IP协议进行数据传输的应用系统和服务都可以使用IPsec，而不必对
	   这些应用系统和服务本身做任何修改。
	3. 对数据的加密是以数据包为单位的，而不是以整个数据流为单位， 这不仅灵
	   活而且有助于进一步提高IP数据包的安全性，可以有效防范网络攻击。
实现:
	IPsec协议不是一个单独的协议，它给出了应用于IP 层上网络数据安全的一整套
	体系结构，包括网络认证协议AH（Authentication Header，认证头）、ESP（En
	capsulating Security Payload，封装安全载荷）、IKE（Internet Key Exchan
	ge，因特网密钥交换）和用于网络认证及加密的一些算法等。其中，AH协议和ES
	P协议用于提供安全服务，IKE协议用于密钥交换。

	IPsec提供了两种安全机制：认证和加密。
AH:
	AH协议（IP协议号为51）提供数据源认证、数据完整性校验和防报文重放功能，
	它能保护通信免受篡改，但不能防止窃听，适合用于传输非机密数据。AH 的工
	作原理是在每一个数据包上添加一个身份验证报文头，此报文头插在标准IP 包
	头后面，对数据提供完整性保护。可选择的认证算法有MD5（Message Digest）
	、SHA-1（Secure Hash Algorithm）等。
ESP:
	ESP协议（IP协议号为50） 提供加密、数据源认证、数据完整性校验和防报文重
	放功能。ESP的工作原理是在每一个数据包的标准IP包头后面添加一个ESP报文头
	并在数据包后面追加一个ESP尾。与AH协议不同的是，ESP将需要保护的用户数据
	进行加密后再封装到IP包中，以保证数据的机密性。常见的加密算法有DES、3DE	把数据封装到IP中,在封到ESP中。
	S、AES等。同时，作为可选项，用户可以选择MD5、SHA-1算法保证报文的完整性
	和真实性。
	
	在实际进行IP通信时，可以根据实际安全需求同时使用这两种协议或选择使用其
	中的一种。AH和ESP都可以提供认证服务，不过，AH提供的认证服务要强于ESP。
	同时使用AH和ESP时，设备支持的AH和ESP联合使用的方式为：先对报文进行 ESP
	封装，再对报文进行AH封装，封装之后的报文从内到外依次是原始IP 报文、ESP
	头、AH头和外部IP头。
安全联盟(Security Association，SA)
	IPsec在两个端点之间提供安全通信，端点被称为IPsec对等体。
	SA是IPsec的基础，也是IPsec的本质。SA是通信对等体间对某些要素的约定，例
	如使用那种协议（AH、ESP 还是两者结合使用）、协议的封装模式（传输模式和
	隧道模式）、加密算法、特定流中保护数据的共享密钥以及密钥的生存周期等。
	建立SA的方式有手工配置和IKE自动协商两种。

	SA是单向的，在两个对等体之间的双向通信，最少需要两个SA来分别对两个方向
	数据流进行安全访问。

	SA由一个三元组来唯一标识，这个三元组包括SPI（Security Parameter Index,
	安全参数索引）、目的IP、安全协议号（AH或ESP）。

	通过IKE协商的SA的具有生存周期，手工方式建立的SA 永不老化。周期可以基于
	时间，基于流量。
封装方式：
	两种工作方式：
	1. 隧道模式：用户的整个IP数据包被用来计算AH或ESP头，AH或ASP以及ESP加密
	   的用户数据被封装在一个新的IP数据包中，通常， 隧道模式应用在两个安全
	   网关之间的通讯。
	2. 传输（transport）模式：只是传输层数据被用来计算AH或ESP头，AH或ESP头
	   以及ESP加密的用户数据被放置在原IP包头后面。通常，传输模式应用在两台
	   主机之间的通讯，或一台主机和一个安全网关之间的通讯。
        | \ mode   |                      |                         |
        | protocol | transport            | tunnel                  |
        | AH       | IP AH Data           | IP AH IP Data           |
        | ESP      | IP ESP Data-T        | IP ESP IP Data ESP-T    |
        | AH-ESP   | IP AH ESP Data ESP-T | IP AH ESP IP Data ESP-t |

认证算法与加密算法
认证算法:
	认证算法的实现主要是通过杂凑函数。杂凑函数是一种能够接受任意长的消息输
	入，并产生固定长度输出的算法，该输出称为消息摘要。IPsec对等体计算摘要，
	如果两个摘要是相同的，则表示报文是完整未经篡改的。IPsec 使用两种认证算
	法：
	1. MD5：MD5通过输入任意长度的消息，产生128bit的消息摘要。
	2. SHA-1：SHA-1通过输入长度小于2的64次方bit的消息，产生160bit的消息摘要
	MD5算法的计算速度比SHA-1算法快，而SHA-1算法的安全强度比MD5算法高。
加密算法:
	加密算法实现主要通过对称密钥系统，它使用相同的密钥对数据进行加密和解密
	目前设备的IPsec实现三种加密算法：
	1. DES（Data Encryption Standard）：使用56bit的密钥对一个64bit的明文块
	   进行加密。
	2. 3DES（Triple DES）：使用三个56bit的DES密钥（共168bit 密钥）对明文进
	   行加密。
	3. AES（Advanced Encryption Standard）：使用128bit、192bit或256bit密钥
	   长度的AES算法对明文进行加密。
	这三个加密算法的安全性由高到低依次是：AES、3DES、DES，安全性高的加密算
	法实现机制复杂，运算速度慢。对于普通的安全要求，DES算法就可以满足需要。
协商方式：
	1. 手工方式（manual）配置比较复杂，创建SA 所需的全部信息都必须手工配置
	   而且不支持一些高级特性（例如定时更新密钥），但优点是可以不依赖 IKE
	   而单独实现IPsec功能。
	2. IKE自动协商（isakmp）方式相对比较简单，只需要配置好IKE 协商安全策略
	   的信息，由IKE自动协商来创建和维护SA。
安全隧道：
	安全隧道是建立在本端和对端之间可以互通的一个通道，它由一对或多对SA组成
使用IPsec保护IPv6路由协议：
	使用IPsec保护IPv6路由协议是指，使用AH/ESP协议对IPv6路由协议报文进行加/
	解封装处理，并为其提供认证和加密的安全服务，目前支持OSPF v3、IPv6 BGP、
	RIPng路由协议。

IKE:
	在实施IPsec的过程中，可以使用IKE（internet Key Exchange ，因特网密钥交
	换）协议来建立SA，该协议建立在由ISAKMP（Internet Security  Association 
	and Key Management Protocol，互联网安全联盟和密钥管理协议） 定义的框架
	上。IKE为IPsec提供了自动协商交换密钥、建立SA的服务，能够简化IPsec 的使
	用和管理，大大简化IPsec的配置和维护工作。

	IKE 不是在网络上直接传输密钥，而是通过一系列数据的交换，最终计算出双方
	共享的密钥，并且即使第三者截获了双方用于计算密钥的所有交换数据，也不足
	以计算出真正的密钥。

	IKE 自有一套自有保护机制，可以在不安全的网络上安全的认证身份、分发密钥
	建立IPsec SA。
IKE的交换过程：
	1. 通信各方彼此间建立一个已通过身份验证和安全保护的通道，即建立一个ISA
	   KMP SA。第一阶段有主模式（Main Mode）和野蛮模式（Aggressive Mode)两
	   种IKE交换方法。
	2. 用在第一阶段建立的安全隧道位IPsec协商安全服务，即为IPsec协商具体的S
	   A，建立用于最终IP数据安全传输的IPsec SA。
ISAKMP:因特网安全联盟和密钥管理协议
	internet密钥交换协议IKE 用于在两个通信实体协商和建立安全相关，交换密钥
	安全相关（Security Association）是IPsec 中的一个重要概念。一个安全相关
	表示两个或多个通信实体之间经过了身份验证，且这些通信实体都能支持相同的
	加密算法，成功地交换了会话密钥，可以开始利用IPsec进行安全通信。IPsec协
	议本身没有提供在通信实体间建立安全相关的方法，利用IKE 建立安全相关。I
	KE定义了通信实体间进行身份验证、协商加密算法以及生成共享的会话密钥的方
	法。

	IKE是一种混合型协议，由RFC2409定义，包含了3个不同协议的有关部分：ISAKM
	P、Oakley和SKEME。IKE和ISAKMP的不同之处在于：IKE真正定义了一个密钥交换
	的过程，而ISAKMP只是定义了一个通用的可以被任何密钥交换协议使用的框架。

	Oakley：定义IKE提供了一个多样化，多模式的应用，让IKE可以用在很多场合

	SKEME：提供了IKE交换密钥的算法，方式；即，通过DH进行密钥交换和管理的方
	式

	ISAKMP：它是一个框架，在该框架内，它定义了每一次交换的包结构，每次需要	RFC2408.适用于VPN的建立。
	几个包交换，在配置IPsec VPN的时候只能设置它，前两个协议不能被设置。

	ISAKMP没有定义任何密钥交换协议的细节，也没有定义任何具体的加密算法、密
	钥生成技术或者认证机制。这个通用的框架是与密钥交换独立的，可以被不同的
	密钥交换协议使用。
	ISAKMP报文可以利用UDP或者TCP，端口都是500，一般情况下常用UDP协议.

IKE中有4种身份认证方式：
	（1） 基于数字签名（Digital  Signature），利用数字证书来表示身份，利用
	      数字签名算法计算出一个签名来验证身份。
	（2） 基于公开密钥（Public Key  Encryption），利用对方的公开密钥加密身
	      份，通过检查对方发来的该HASH值作认证。
	（3） 基于修正的公开密钥（Revised Public Key  Encryption），对上述方式
	      进行修正。
	（4） 基于预共享字符串（Pre Shared Key），双方事先通过某种方式商定好一
	      个双方共享的字符串。

IKE模式：
	IKE目前定义了4种模式：主模式、积极模式、快速模式和新组模式。前面3 个用
	于协商SA，最后一个用于协商Diffie Hellman算法所用的组。主模式和积极模式
	用于第一阶段；快速模式用于第二阶段；新组模式用于在第一个阶段后协商新的
	组。
	在第一阶段中：
	主模式：LAN to LAN 六个包交换，在认证的时候是加密的.
	1 -2个包：策略和转换集的协商。第一阶段的加密和HASH的策略，包括对方的IP
	   地址。对第阶段策略的协商， 发起者把它所有的策略发给接收者让它选择协
	   商（发起者可以设很多个策略），
	3 -4个包：进行DH（DH算出的公共值和两边产生的随机数）的交换，这两外包很
	   大，MTU小可能在这个地方出错。
	5 -6个包：彼此进行认证，HASH被加密过，对方解密才能进行认证。
	远程拔号VPN：主动模式，3个包，减少对PC的压力，在认证的时候是不加密的

	在第二阶段中（快速模式）：会对第一阶段的信息再做一次认证
	快速模式：当IP SEC参数设的不一致，它会在快速模式的第1、2个包报错，会出
	现不可接受信息。以及感兴趣流（ACL定义内容）也要匹配。ACL两边要对应一致。
	快速模式的1、2、3个包的作用是再进行双方的认证，协商IP sec SA的策略，建
	立IP sec的安全关联，周期性的更新IP sec的SA，默认一小时一次，ISAKMP默认
	是一天更新一次，协商双方的感兴趣流，如果有PFS，就会进行新一轮的DH交换，
	过程与第一阶段的DH交换基本一样。

IPsec与IKE的关系：
	1.IKE是UDP之上的一个应用层协议，是IPsec的信令协议；
	2.IKE为IPsec协商建立SA，并把建立的参数及生成的密钥交给IPsec；
	3.IPsec使用IKE建立的SA对IP报文加密或认证处理。
