# 心跳报文
实现向后台服务器发送$ping$包，探测后台服务是否在活动状态，并且还能发送报警报文。

## 主线
用start函数添加第一个定时器。

心跳模块主处理函数`hf_if_process()`嵌入定时器模块中，在初始化的时候已经设置好定时器wqe的`grp`,`unused`,`qos`。

当然还初始化`本地IP MAC`,`远端IP MAC`等信息，每个接口一个数据结构。

如果一个端口的计数`th_cnt`大于了设定的上限，那就会把接口的`link`状态置零（如果原来是被置位的话）。

```
问：这里的link不是switch里面独到的link状态，也不是port的状态，而是cpu内部自己组织的另一个标志？
答：是自己组织的一个标志，在转发的时候会重新组织一个新的出口组。

问：原来CPU怎样和switch的端口状态进行交互的？向接口组里面添加link状态是down的接口，能添加成功也能，show出来
那么在出口进行负载均衡的时候是怎么处理的？
答：没有进行交互，不管端口的状态，cpu会打上相应端口的vlan，发送给switch，switch根据状态决定是否转发。
```

`phb->flag_rhwaddr_manl`的用途: mduapi在设置的时候会检查配置下来的远端mac地址，是否为空。如为空就会被置1，为空，就会被置0.在`th_cnt`超出上限的时候如果为0就会把远端mac地址，置为全`0xFF`。

> 就是说如果用户没有配置远端的mac地址，这个标志会被置零，然后在每次计数超限的时候就会把远端MAC地址置为全`FF`。然后后续发送arp报文，再次获取mac地址，如果一直是超限的话会一直发送arp消息。

`th_cnt`大于设定上限时候，会判断报警报文是否开启。如果开启，就会向配置的出口发送报警。

检查远端MAC地址是否全为`0xFF`，是发ARP报文，不是发ICMP报文。发送响应报文时候，会把`th_cnt`加一（$在th_cnt大于上限的情况下也是,会有个溢出的bug$）.

## 处理心跳ARP
入口在报文decode完成后，作报文类型检查的时候。

arp数据部分的目的IP和入口的虚拟IP一致，继续处理。

判断arp类型，请求消息则把进入的报文修改成响应包再在进接口发出去。响应消息的话就把mac地址学到接口的心跳结构中,并且把计数设置为0。

## 处理心跳ICMP
入口在报文decode完成后，作报文类型检查的时候。

icmp报文,ip头的目的IP和入口的虚拟IP一致，继续处理。

echo请求的发送响应的报文。响应消息，计数置零。

## 心跳配置
总开关：如果心跳配置宏开启了就默认设置为1，否则为0.也没有看到在什么地方检查这个开关。只是用于显示是否（版本）支持此功能。

对应每个口，配置结构。然后set，get。

## 对报文出口的影响
如上修改出口的link状态时所说，这里定义一个临时的出口数目，和临时的出口组。然后通过判断出口的状态填充这个两个临时变量，获得出接口。
