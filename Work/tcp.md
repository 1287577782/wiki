=tcp=

==tcp协议结构==
TCP 是一种可靠的，面向连接的字节流服务。先建立连接，在此连接上，被编号的数据段
按序收发。同时，对每个数据段进行确认，保证了可靠性。
    1.	|     源端口号16        |       目标端口16      | -\
    2.                        顺序号32                  |   \
    3.                        确认号32                  |    - 20字节
    4.	头部长度|保留| | | | | | |      窗口大小16      |   /
    5.	         校验和         |       紧急指针16      | -/
    			可    选    项32                |    - 4字节
    			数	    据                  |
源，目标端口号字段：占16比特。TCP 协议通过使用“端口”来标识源和目标端的应用进程
端口号可以使用0到65535之间的任何数字。在收到服务请求时，操作系统动态的为客户端
的应用程序分配端口号。在服务端，每种服务在“众所周知的端口” （well-know Port)为
用户提供服务。

顺序号字段：占32比特。用来标识从TCP源端向TCP目标端发送的数据字节流，它表示在这
个报文段中的第一个数据字节。

确认号字段：占32比特。只有ACK标志为1时，确认字段才有效。它包含目标端所期望收到
源端的下一个数据字节。

头部长度字段：占4比特。给出头部占32比特的数目。没有任何选项字段的TCP头部长度为
20字节；最多可以有60字节的TCP头部。

标志位字段（U、A、P、R、S、F）：占6比特。各比特的含义如下：
    - URG：紧急指针（urgent pointer）有效。
    - ACK：确认序号有效。
    - PSH：接收方应该尽快将这个报文段交给应用层。
    - RST：重建连接。
    - SYN：发起一个连接。
    - FIN：释放一个连接。

窗口大小字段：占16比特。此字段用来进行流量控制。单位为字节数，这个值是本机期望
一次接收的字节数。

TCP校验和字段：占16比特。对整个TCP报文段，即TCP头部和TCP数据进行校验和计算，并
由目标端进行验证。

紧急指针字段：占16字段。它是一个偏移量，和序号字段中的值相加表示紧急数据最后一
个字节的序号。

选项字段：占32比特。可能包括窗口扩大因子，时间戳等选项。

==三次握手-建立连接==
* 第一次握手：主机A发送位码syn=1，随机产生seq number=1234567的数据包到服务器，并进入SYN_SEND状态，等待服务器确认。主机B由SYN=1知道，A要求建立联机；
* 第二次握手：主机B收到请求后确认联机信息，同A发送ack number=（A的seq+1），syn=1，ack=1，随机产生seq=7654321的包
* 第三次握手：主机A收到后检查ack number是否正确，即第一次发送的seq number + 1，以及位码ack是否为1，若正确，主机A会再发送ack number=（主机B的seq+1），ack=1，主机B收到确认seq number值与ack=1，则连接建立成功。
```
    --->	序列号=1655526439，确认号=0000000000，标志=....S..
    <---	序列号=3581866967，确认号=1655526440，标志=.A..S..
    --->	序列号=1655526440，确认号=3581866968，标志=.A.....
```

==四次分手-连接终止==
由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。一方的数据发送完成后就能发送一个FIN来终止这个连接。收到一个FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方这行被动关闭。

TCP通过滑动窗口的概念来进行流量控制。设想在发送端发送数据的速度很快而接收端接收速度却很慢的情况下，为了保证数据不丢失，显然需要进行流量控制， 协调好通信双方的工作节奏。所谓滑动窗口，可以理解成接收端所能提供的缓冲区大小。TCP利用一个滑动的窗口来告诉发送端对它所发送的数据能提供多大的缓 冲区。由于窗口由16位bit所定义，所以接收端TCP 能最大提供65535个字节的缓冲。由此，可以利用窗口大小和第一个数据的序列号计算出最大可接收的数据序列号。 

滑动窗口本质上是描述接受方的TCP数据报缓冲区大小的数据，发送方根据这个数据来计算自己最多能发送多长的数据。如果发送方收到接受方的窗口大小为0的TCP数据报，那么发送方将停止发送数据，等到接受方发送窗口大小不为0的数据报的到来。 
关于滑动窗口协议，还有三个术语，分别是： 

窗口合拢：当窗口从左边向右边靠近的时候，这种现象发生在数据被发送和确认的时候。   
窗口张开：当窗口的右边沿向右边移动的时候，这种现象发生在接受端处理了数据以后。   
窗口收缩：当窗口的右边沿向左边移动的时候，这种现象不常发生。   
TCP就是用这个窗口，慢慢的从数据的左边移动到右边，把处于窗口范围内的数据发送出去（但不用发送所有，只是处于窗口内的数据可以发送。）。这就是窗口 的意义。窗口的大小是可以通过socket来制定的，4096并不是最理想的窗口大小，而16384则可以使吞吐量大大的增加。

  A—————C—————B   
  如上图，A与B之间建立TCP连接，滑动窗口实现有两个作用：   
    
  由于对称性，只考虑A端发送窗口和B端接收窗口，有如下两个作用   
    
  1。B端来不及处理接收数据（控制不同速率主机间的同步），这时，A通过B端通知的接收窗口而减缓数据的发送。   
  2。B端来得及处理接收数据，但是在A与B之间某处如C，使得AB之间的整体带宽性能较差，此时，A端根据拥塞处理策略（慢启动，加倍递减和缓慢增加）来更新窗口，以决定数据的发送。   

与固定大小的滑窗协议相比，TCP采用可变大小的滑窗协议是为了取得更好的性能。   
    
  TCP是一个广域网协议，而广域网环境下的路由器和主机，各自有着不同的性能和处理能力，在这种情况下，采用固定窗口大小的滑窗协议会引起性能上的损失。TCP规定窗口的大小是由接收方通告的，通过采取慢启动和拥塞避免算法等机制来使带宽和性能取得最佳。

